/* This script creates a weekly timeline into newly created columns as headers given start date, end date, and calculated number of weeks between dates 
*
* Google Sheet Pre-requisites:
* start date, end date, and calculated number of weeks between dates in separate cells
* google drawing button
*
*/

function timelinePhases (){ // create timeline and phase blocks for timeline tab
  //Setting cells to grab week numbers, endDate, startDate
  var numWeeksCell = "E2"; //CHANGE to cell that holds number of weeks
  var endDateCell = "C3";  //CHANGE to cell that holds end date
  var startDateCell = "C2"; //CHANGE to cell that holds start date

  //grab Timeline tab
  var sh1 = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet1") //CHANGE to sheet name


  var numWeeks = sh1.getRange(numWeeksCell).getValue();
  var endDate = sh1.getRange(endDateCell).getValue();
  var endDate = new Date(sh1.getRange(endDateCell).getValue());
  var newDate = new Date();


  if (numWeeks < 12){ // weekly timeline if project is less than 12 weeks
    // creates first column 
    //CHANGE number in functions to customize font, color, and location of dates
    sh1.insertColumnBefore(6);
    sh1.getRange(5,6 ).setValue(endDate);
    sh1.getRange(5,6 ).setTextRotation(90);
    sh1.setColumnWidth(6,60);
    sh1.getRange(5,6 ).setBackground("#a61c00");
    sh1.getRange(5,6 ).setFontColor("white");
    sh1.getRange(5,6 ).setFontWeight("bold");

    //creates subsequent weeks and columns
    for (i = 0; i < numWeeks; i++){
      console.log("in loop");
      newDate = subWeeks(endDate);
      endDate = newDate;
      
      //CHANGE number in functions to customize font, color, and location of date
      sh1.insertColumnBefore(6);
      sh1.getRange(5,6 ).setValue(newDate);
      sh1.setColumnWidth(6,60);
      sh1.getRange(5,6 ).setBackground("#a61c00");
      sh1.getRange(5,6 ).setFontColor("white");
      sh1.getRange(5,6 ).setFontWeight("bold");
    }

     phasesColorr(); //colors phases by week

  }else if (numWeeks >= 12 && numWeeks < 52){
    var startMonth = sh1.getRange(2,3).getValue().getMonth() + 1;
    var endMonth = sh1.getRange(3,3).getValue().getMonth() + 1;

    if (endMonth < startMonth){
      endMonth =+ 13;
    }

    var numMonths = (endMonth - startMonth) + 1;

    for (i = 0; i < numMonths; i++){
      var year = sh1.getRange(startDateCell).getValue().getFullYear()
      sh1.insertColumnBefore(6);
      sh1.getRange(5,6 ).setValue(numberToMonth(endMonth) + " " + year); // converts number month to string months then set month to column header
      sh1.getRange(5,6 ).setTextRotation(90);
      sh1.setColumnWidth(6,60);
      sh1.getRange(5,6 ).setBackground("#a61c00");
      sh1.getRange(5,6 ).setFontColor("white");
      sh1.getRange(5,6 ).setFontWeight("bold");
      endMonth--;
    }
    colorByMmonth();
  }else { // monthly timeline if project is a year or more
    var numMonths = numWeeks / 4; // calculates the number of months in a project based on weeks
    var startMonth = endDate.getMonth() + 1;
    var year = sh1.getRange(startDateCell).getValue().getFullYear() + 1;

    //create first column
    sh1.insertColumnBefore(6);
    sh1.getRange(5,6 ).setValue(numberToMonth(startMonth) + " " + year); // converts number month to string months then set month to column header
    sh1.getRange(5,6 ).setTextRotation(90);
    sh1.setColumnWidth(6,60);
    sh1.getRange(5,6 ).setBackground("#a61c00");
    sh1.getRange(5,6 ).setFontColor("white");
    sh1.getRange(5,6 ).setFontWeight("bold");
    startMonth --; // creates last month column first

    //creates subsequent month columns
    for (i = 0; i < numMonths - 2; i++){
      sh1.insertColumnBefore(6);
      sh1.getRange(5,6 ).setValue(numberToMonth(startMonth) + " " + year);
      sh1.setColumnWidth(6,60);
      sh1.getRange(5,6 ).setBackground("#a61c00");
      sh1.getRange(5,6 ).setFontColor("white");
      sh1.getRange(5,6 ).setFontWeight("bold");
      startMonth --;

      //reset month once year is over
      //increments year once months reset
      if (startMonth == 0){
        startMonth = 12;
        year --;
      }

    
    }
    colorByMmonth(); // color phases by months
  }
}

function numberToMonth (monthNum){ // converts month numbers to month names
  var monthString;
  if (monthNum == 1){
    monthString = "January"    
  } else if (monthNum == 2){
    monthString = "February"    
  } else if (monthNum == 3){
    monthString = "March"    
  } else if (monthNum == 4){
    monthString = "April"    
  } else if (monthNum == 5){
    monthString = "May"    
  } else if (monthNum == 6){
    monthString = "June"    
  } else if (monthNum == 7){
    monthString = "July"    
  } else if (monthNum == 8){
    monthString = "August"    
  } else if (monthNum == 9){
    monthString = "September"    
  } else if (monthNum == 10){
    monthString = "October"    
  } else if (monthNum == 11){
    monthString = "November"    
  } else if (monthNum == 12){
    monthString = "December"    
  }

  return monthString;
}


function phasesColorr() { //detemines phase blocks and colors
//set cells to grab info from 
var prepCell = "C6"
var confirmationCell = "C7";
var designCell = "C8";
var buildCell = "C9";
var deployCell = "C10";
var hypercareCell = "C11";
var sheetName = "Timeline";

//takes weeks for each phase
var sh2 = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName)
var prep = sh2.getRange(prepCell).getValue();
var confirmation = sh2.getRange(confirmationCell).getValue();
var design = sh2.getRange(designCell).getValue();
var build = sh2.getRange(buildCell).getValue();
var deploy = sh2.getRange(deployCell).getValue();
var hypercare = sh2.getRange(hypercareCell).getValue();

//gets number of blocks to be colored in then adds to previous phase
if (prep != 0){
  sh2.getRange(6,6,1,prep).setBackground("#dedede");
  sh2.setRowHeight(5,60);
}

var endCol = prep + 6;
if (confirmation != 0) {
  sh2.getRange(7,endCol,1,confirmation).setBackground("#d9d9d9");
}

endCol += confirmation;
if (design != 0) {
  sh2.getRange(8,endCol,1,design).setBackground("#b7b7b7");
}

endCol += design;
if (build != 0){
  sh2.getRange(9,endCol,1,build).setBackground("#666666");
} 

endCol += build;
if (deploy != 0) {
  sh2.getRange(10,endCol,1,deploy).setBackground("#434343");
} 

endCol += deploy;
if (hypercare != 0) {
  sh2.getRange(11,endCol,1,hypercare+1).setBackground("#000000");
}

}


//colors in phases by month
function colorByMmonth(){
  colorSet("D6","E6",6,"#dedede");
  colorSet("D7","E7",7,"#d9d9d9");
  colorSet("D8","E8",8,"#b7b7b7");
  colorSet("D9","E9",9,"#666666");
  colorSet("D10","E10",10,"#434343");
  colorSet("D11","E11",11,"#000000");

}


function colorSet(ssCell,eeCell,row, color) {
  //find number of blocks to be colored for each phase
  var sheetName = "Timeline";
  var sh2 = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName)
 
  //month tracker
  var checkCellCol = 6;
  var checkMonth = sh2.getRange(5, checkCellCol).getValue().getMonth() + 1;
  var checkYear = sh2.getRange(5, checkCellCol).getValue().getFullYear();
  var checking = numberToMonth(checkMonth) + " " + checkYear;

  //find start date 
  var start = sh2.getRange(ssCell).getValue().getMonth() + 1;
  var startString = numberToMonth (start);
  var startYear = sh2.getRange(ssCell).getValue().getFullYear();
  var startDate = startString + " " + startYear;

  //find end date
  var end = sh2.getRange(eeCell).getValue().getMonth() + 1;
  var endString = numberToMonth (end);
  var endYear = sh2.getRange(eeCell).getValue().getFullYear();
  var endDate = endString + " " + endYear;

  var numCol = 1; 

  //finds where to start coloring blocks
  while(startDate != checking){
    checkCellCol ++;

    checkMonth = sh2.getRange(5, checkCellCol).getValue();
    checkMonth = checkMonth.getMonth() + 1;
    checkYear = sh2.getRange(5, checkCellCol).getValue().getFullYear();
    checking = numberToMonth(checkMonth) + " " + checkYear;

  }

  var col = checkCellCol;

  //finds how many blocks to color
  while(checking != endDate){
    checkCellCol ++;
    checkMonth = sh2.getRange(5, checkCellCol).getValue();
    checkMonth = checkMonth.getMonth() + 1;
    checkYear = sh2.getRange(5, checkCellCol).getValue().getFullYear();
    checking = numberToMonth(checkMonth) + " " + checkYear;
    numCol++;
  }

  sh2.getRange(row, col,1,numCol).setBackground(color);

}


